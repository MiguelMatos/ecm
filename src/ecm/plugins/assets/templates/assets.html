{% extends "base.html" %}

{% block headtitle %}Assets{% endblock %}

{% block breadcrumbs %}
<li><a href="/">Home</a></li>
<li><a href="/assets/" >Assets</a></li>
{% endblock %}

{% block main_content %}
<div class="page-header">
<h1>Corporation Assets <small>last update {{ scan_date|ecm_datetime }}</small></h1>
</div>

<form id="search_form" class="form-search form-inline">
  <div class="btn-toolbar" >
    <input type="text" id="search_text" class="input-medium search-query" value="" />
    <div class="btn-group">
      <button type="submit" class="btn btn-small" id="search_button"><i class="icon-search"></i> Search</button>
      <button class="btn btn-small" id="clear_search">Reset</button>
    </div>
    <span class="label label-important">Tree</span>
    <div class="btn-group">
      <button class="btn btn-small btn-danger" id="expand_all">Expand All</button>
      <button class="btn btn-small btn-danger" id="close_all">Collapse All</button>
    </div>
  </div>
</form>

<div class="well well-tight">
  <div class="btn-toolbar" >
    <span class="label label-info">Divisions</span>
    <div title="Press CTRL + Click to select only one" class="btn-group" data-toggle="buttons-checkbox">
    {% for h in hangars %}
      <button class="btn btn-mini btn-info" id="{{ h.hangarID }}" >{{ h.name }}</button>
    {% endfor %}</div>
  </div>
  <div class="btn-toolbar" >
    <span class="label label-success">Locations</span>
    <div title="Press CTRL + Click to select only one" class="btn-group" data-toggle="buttons-checkbox">
      <button class="btn btn-mini btn-success" id="show_stations" >In Station</button>
      <button class="btn btn-mini btn-success" id="show_space" >In Space</button>
    </div>
  </div>
  <div class="btn-group">
    <a class="btn btn-mini" id="apply_filter"><i class="icon-ok"></i> Apply Filter</a>
    <a class="btn btn-mini" id="reset_filter"><i class="icon-remove"></i> Reset</a>
  </div>
</div>

<div id="assets_tree"></div>
{% endblock %}


{% block javascripts %}
<script type="text/javascript">
SHOW_DIVISIONS = "{{ divisions_str }}";
SHOW_IN_SPACE = {% if show_in_space %}true{% else %}false{% endif %};
SHOW_IN_STATIONS = {% if show_in_stations %}true{% else %}false{% endif %};
BASE_URL = '/assets/';
</script>
{% endblock %}


{% block compressed_javascripts %}
<script type="text/javascript" src="/s/ecm/js/lib/jquery.jstree.js"></script>
<script>
$(function () {

    $('#assets_tree').jstree({
        plugins : [ 'themes' , 'json_data' , 'search' , 'adv_search' , 'ui',  'types' , 'sort' ],
        core : {
            animation : 150,
            html_titles : true
        },
        ui : {
            select_limit : 1
        },
        themes : {
            url : '/s/assets/css/jstree.css',
            dots : false
        },
        search : {
            case_insensitive : true,
            ajax : {
                url : function() {
                    var params = {
                        stations : SHOW_IN_STATIONS,
                        space : SHOW_IN_SPACE
                    };
                    if (SHOW_DIVISIONS != 'None') {
                        params['divisions'] = SHOW_DIVISIONS;
                    }
                    return BASE_URL + 'search/?' + decodeURIComponent(jQuery.param(params));
                }
            }
        },
        types : {
            max_depth : -2,
            max_children : -2,
            valid_children : [ 'system' ],
            types : {
                system : {
                    class : 'system-row',
                    icon : {
                        image : '/s/assets/img/system.png'
                    },
                    valid_children : [ 'array', 'station' ],
                    max_depth : 5,
                    open_node   : true,
                    close_node  : true
                },
                array : {
                    class : 'hangar-row',
                    icon : {
                        image : '/s/assets/img/array.png'
                    },
                    valid_children : [ 'hangar' ],
                    max_depth : 4,
                    open_node   : true,
                    close_node  : true
                },
                station : {
                    class : 'station-row',
                    icon : {
                        image : '/s/assets/img/station.png'
                    },
                    valid_children : [ 'hangar' ],
                    max_depth : 4,
                    open_node   : true,
                    close_node  : true
                },
                hangar : {
                    class : 'hangar-row',
                    icon : {
                        image : '/s/assets/img/hangar.png'
                    },
                    valid_children : [ 'can', 'mineral', 'ship',  'ammo', 'blueprint', 'item' ],
                    max_depth : 3,
                    open_node   : true,
                    close_node  : true
                },
                ship : {
                    icon : {
                        image : '/s/assets/img/ship.png'
                    },
                    valid_children : [ 'can', 'mineral', 'ship',  'ammo', 'blueprint', 'item' ],
                    max_depth : 2,
                    open_node   : true,
                    close_node  : true
                },
                can : {
                    icon : {
                        image : '/s/assets/img/can.png'
                    },
                    valid_children : [ 'can', 'mineral', 'ship',  'ammo', 'blueprint', 'item' ],
                    max_depth : 1,
                    open_node   : true,
                    close_node  : true
                },
                item : {
                    icon : {
                        image : '/s/assets/img/item.png'
                    },
                    valid_children : 'none',
                    max_depth : 0,
                    select_node : true,
                    open_node   : true,
                    close_node  : true,
                    create_node : false,
                    delete_node : false
                },
                mineral : {
                    icon : {
                        image : '/s/assets/img/mineral.png'
                    },
                    valid_children : 'none',
                    max_depth : 0,
                    select_node : true,
                    open_node   : true,
                    close_node  : true,
                    create_node : false,
                    delete_node : false
                },
                blueprint : {
                    icon : {
                        image : '/s/assets/img/blueprint.png'
                    },
                    valid_children : 'none',
                    max_depth : 0,
                    select_node : true,
                    open_node   : true,
                    close_node  : true,
                    create_node : false,
                    delete_node : false
                },
                ammo : {
                    icon : {
                        image : '/s/assets/img/ammo.png'
                    },
                    valid_children : 'none',
                    max_depth : 0,
                    select_node : true,
                    open_node   : true,
                    close_node  : true,
                    create_node : false,
                    delete_node : false
                },
                skill : {
                    icon : {
                        image : '/s/assets/img/skill.png'
                    },
                    valid_children : 'none',
                    max_depth : 0,
                    select_node : true,
                    open_node   : true,
                    close_node  : true,
                    create_node : false,
                    delete_node : false
                }
            }
        },
        json_data : {
            ajax : {
                url : function(node) {
                    var url = BASE_URL;
                    url += node.attr ? node.attr('id').replace(/_/g, '/') : '';
                    url += 'data/'
                    var params = {
                        'stations' : SHOW_IN_STATIONS,
                        'space' : SHOW_IN_SPACE
                    };
                    if (SHOW_DIVISIONS != 'None') {
                        params.divisions = SHOW_DIVISIONS;
                    }
                    return url + '?' +  decodeURIComponent(jQuery.param(params));
                }
            }
        },
        sort : function (a, b) {
            if ('sort_key' in a.attributes && 'sort_key' in b.attributes) {
                var key_a = +a.attributes.sort_key.value;
                var key_b = +b.attributes.sort_key.value;
                if (isNaN(key_a)) {
                    key_a = a.attributes.sort_key.value;
                }
                if (isNaN(key_b)) {
                    key_b = b.attributes.sort_key.value;
                }
                if (key_a > key_b) {
                    return 1;
                } else {
                    return -1;
                }
            } else {
                return 0;
            }
        }
    });
});

$('#search_form').submit(function(event) {
    event.preventDefault();
    $('#assets_tree').jstree('search', $('#search_text').val());
});

$('#clear_search').click(function() {
    $('#search_text').val('');
    $('#assets_tree').jstree('clear_search');
});

$('#expand_all').click(function() {
    $('#assets_tree').jstree('open_all');
});

$('#close_all').click(function() {
    $('#assets_tree').jstree('close_all');
});

$('#apply_filter').click(function() {
    var params = {
        stations : $('#show_stations').attr('checked'),
        space : $('#show_space').attr('checked')
    };
    var checkboxes = $('.hangar-checkbox');
    var divisions = '';
    for (var i=0 ; i < checkboxes.length ; i++) {
        if (checkboxes[i].checked) {
            divisions += ',' + checkboxes[i].id;
        }
    }
    if (divisions.length != 0) {
        divisions = divisions.substring(1);
        params['divisions'] = divisions;
    }

    window.location = BASE_URL + '?' + decodeURIComponent(jQuery.param(params));
});

$('#reset_filter').click(function() {
    window.location = BASE_URL;
});

$('.hangar-checkbox').click(function (event) {
    if (event.ctrlKey) {
        /* if ctrl + click, deselect all divisions and select only this one */
        var checkboxes = $('.hangar-checkbox');
        for (var i=0 ; i < checkboxes.length ; i++) {
            checkboxes[i].checked = false;
        }
        this.checked = true;
    }
});

$('.space-checkbox').click(function (event) {
    if (event.ctrlKey) {
        /* if ctrl + click, deselect all divisions and select only this one */
        var checkboxes = $('.space-checkbox');
        for (var i=0 ; i < checkboxes.length ; i++) {
            checkboxes[i].checked = false;
        }
        this.checked = true;
    }
});

$('#assets_tree').delegate('a', 'click', function (event, data) { 
    event.preventDefault(); 
});

$('#assets_tree').delegate('a', 'dblclick', function(e) {
    $('#assets_tree').jstree('open_node', $(this).parent());
});

</script>
{% endblock %}

