{% extends "base.html" %}

{% block headtitle %}Create new Order{% endblock %}

{% block stylesheets %}
<link rel="stylesheet" type="text/css" href="/s/ecm/css/jquery.autocomplete.css" />
<link rel="stylesheet" type="text/css" href="/s/industry/css/industry.css" />
<style type="text/css">
#eft-modal {display: none;}
.throbber {display:none;}
</style>
{% endblock %}



{% block breadcrumbs %}
<li><a href="/">Home</a></li>
<li><a href="/shop/">Industry</a></li>
<li><a href="/shop/orders/">Orders</a></li>
{% if order %}
<li><a href="/shop/orders/{{ order.id }}/">#{{ order.id }}</a></li>
<li><a href="/shop/orders/{{ order.id }}/modify/">Modify</a></li>
{% else %}
<li><a href="/shop/orders/create/">Create New Order</a></li>
{% endif %}
{% endblock %}

{% block main_content %}
<h1>Please add items to your basket</h1>

<form class="well middle" id="search_form">
    <input type="text" id="search_box" class="no-margin"/>
    <a class="btn btn-info" id="add_button"><i class="icon-plus icon-white"></i> Add to my order</a>
    <a class="btn btn-primary" data-toggle="modal" data-target="#eft-modal" ><i class="icon-plane icon-white"></i> Import EFT Fitting</a>
</form>

<img id="throbber-eft" class="throbber" src="/s/ecm/img/throbber.gif" alt="Loading..." title="Loading..."/>

{% if order %}
<form method="post" action="/shop/orders/{{order.id}}/modify/" id="items_form" >{% else %}
<form method="post" action="/shop/orders/create/" id="items_form" >{% endif %}

{% csrf_token %}
  <table class="order_table">
    <thead>
      <tr>
        <th style="width: 10%;">Icon</th>
        <th style="width: 40%;">Item</th>
        <th style="width: 20%;">Unit Price</th>
        <th style="width: 20%;">Quantity</th>
        <th style="width: 10%;">Remove</th>
      </tr>
    </thead>
  <tbody id="items">
    {% for row in order.rows.all %}
    <tr id="{{row.catalog_entry.typeID}}">
      <td class="center">
          <img src="http://image.eveonline.com/Type/{{row.catalog_entry.typeID}}_32.png" />
      </td>
      <td class="center"><strong>{{row.catalog_entry.typeName}}</strong></td>
      <td class="center">
          <input class="span2" type="text" name="{{row.catalog_entry.typeID}}" value="{{row.quantity}}" />
      </td>
      <td class="center">
        <a class="btn btn-small btn-danger" onClick="javascript:removeItem(this);"><i class="icon-trash icon-white"></i></a>
      </td>
    </tr>
    {% empty %}
    <tr id="empty">
        <td colspan="4" class="order_cart_empty" >Your shopping cart is empty.</td>
    </tr>
    {% endfor %}
  </tbody>
  </table>
  <p style="font-size: 150%;"><span class="bold">TOTAL PRICE:</span>  <span id="total_price">0.0 ISK</span></p>

  <button class="btn btn-success" type="submit"><i class="icon-shopping-cart icon-white"></i> Submit Order</button>
  <img id="throbber-submit" class="throbber" src="/s/ecm/img/throbber.gif" alt="Loading..." title="Loading..."/>
</form>

<div class="modal" id="eft-modal">
  <div class="modal-header">
    <a class="close" data-dismiss="modal">&times;</a>
    <h3>Please paste a fitting export from EFT</h3>
  </div>
  <div class="modal-body">
    <textarea id="eft-block" style="width:100%;" rows="10"></textarea>
  </div>
  <div class="modal-footer form-inline">
    <label for="eft-quantity">Quantity</label>
    <input id="eft-quantity" name="eft-quantity" class="span2" value="1"/>
    <a id="eft-submit" class="btn btn-primary" data-dismiss="modal">Import EFT Fitting</a>
  </div>
</div>
{% endblock %}



{% block compressed_javascripts %}
<script type="text/javascript" src="/s/ecm/js/lib/jquery.autocomplete.js"></script>
<script>
NEW_ITEM =
'<tr id="%typeID">' +
 '<td class="center"><img src="http://image.eveonline.com/Type/%typeID_32.png" /></td>' +
 '<td class="center"><strong>%typeName</strong></td>' +
 '<td class="right price" price="%price">%formattedPrice</td>' +
 '<td class="center"><input class="span2" type="text" name="%typeID" value="%quantity" /></td>' +
 '<td class="center"><a class="btn btn-small btn-danger" onClick="javascript:removeItem(this);"><i class="icon-trash icon-white"></i></a></td>' +
'</tr>';
EMPTY = '<tr id="empty"><td colspan="4" class="order_cart_empty" >Your shopping cart is empty.</td></tr>';

function removeItem(img_node) {
    var row = img_node.parentNode.parentNode;
    var typeName = $('td:eq(1)', row).text();
    if (confirm('Are you sure you want to remove "' + typeName + '" from your order?')) {
        $(row).remove();
        var rows =  $('#items tr');
        if (rows.length == 0) {
            $('#items').html(EMPTY);
        }
        updateTotal();
    }
}

function addItem(name) {
    if (name == '') {
        return;
    }
    $.getJSON("/shop/utils/itemid/", {q: name}, function(json) {
        var typeID = json[0];
        var typeName = json[1];
        var price = json[2];
        appendItemToOrder(typeID, typeName, 1, price);
        $("#search_box").val("");
        updateTotal();
    }).error(function () {
        alert('Item "' + name + '" is not available in the shop!');
    });
}

function appendItemToOrder(typeID, typeName, quantity, price) {
    $('#empty').remove();
    var rows =  $('#items tr');
    var formattedPrice = 'N/A';
    if (price != null) {
        formattedPrice = (price).formatMoney();
    }
    for (var i = 0 ; i < rows.length ; i++) {
        if (parseInt(rows[i].id) == parseInt(typeID)) {
            var qty = parseInt($('td:eq(3) input', rows[i]).val());
            $('td:eq(2)', rows[i]).text(formattedPrice);
            $('td:eq(2)', rows[i]).attr('price', price);
            $('td:eq(3) input', rows[i]).val(qty + quantity);
            return;
        }
    }
    var row = NEW_ITEM.replace(/%typeID/g, typeID)
                      .replace(/%typeName/g, typeName)
                      .replace(/%quantity/g, quantity)
                      .replace(/%formattedPrice/g, formattedPrice)
                      .replace(/%price/g, price);

    $(row).appendTo("#items");
    $('#' + typeID + ' td:eq(3) input').change(updateTotal);
}

function updateTotal() {
    var total = 0.0;
    var rows =  $('#items tr');
    var price = 0.0;
    for (var i = 0; i < rows.length; i++) {
        if (rows[i].id != 'empty') {
            var price = $('td.price', rows[i]).attr('price');
            var qty = $('td:eq(3) input', rows[i]).val();
            if (price == 'null') {
                $('span#total_price').text('N/A');
                return;
            } else {
                total += parseFloat(price) * parseInt(qty);
            }
        }
    }
    $('span#total_price').text((total).formatMoney() + ' ISK');
}


$(document).ready(function() {
    $("#search_box").autocomplete("/shop/utils/search/", {
        minChars: 3,
        selectFirst: true,
    });
    
    /* trigger the search when pressing return in the text field */
    $("#search_form").submit(function(event) {
        event.preventDefault();
        addItem($("#search_box").val());
    });

    /* trigger the search when clicking the "search" button */
    $("#add_button").click(function() {
        addItem($("#search_box").val());
    });

    /* avoid submitting empty orders */
    $("#items_form").submit(function(event) {
        if ($('#empty').length > 0) {
            event.preventDefault();
        } else {
            $('#throbber-submit').show();
        }
    });


    /* when eft modal dialog is submited */
    $('a#eft-submit').click(function () {
        $('#throbber').show();
        $.post('/shop/utils/parseeft/', {
            'eft_block': $('#eft-block').val(),
            'quantity': $('#eft-quantity').val()
         })
         .success(function (data) {
             for (var i=0; i < data.length; i++) {
                 appendItemToOrder(data[i].typeID,
                                   data[i].typeName,
                                   data[i].quantity,
                                   data[i].price);
             }
             updateTotal();
             $('#eft-block').val('');
             $('#eft-quantity').val('1')
         })
         .error(function () {
             alert('Error while parsing EFT fitting!');
         })
         .complete(function () {
             $('#throbber').hide();
         });
    });
});

</script>
{% endblock %}

